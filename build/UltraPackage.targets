<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" DefaultTargets="Layout" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemGroup>
    <LinuxDistrosNeedNativeInstaller Include="ubuntu.16.04-x64">
      <DockerFolder>ubuntu.16.04</DockerFolder>
    </LinuxDistrosNeedNativeInstaller>
    <LinuxDistrosNeedNativeInstaller Include="ubuntu.16.10-x64">
      <DockerFolder>ubuntu.16.10</DockerFolder>
    </LinuxDistrosNeedNativeInstaller>
  </ItemGroup>

  <ItemGroup>
      <_RepoRootFiles Include="$(RepoRoot)/**/*.*" Exclude="$(RepoRoot)/artifactsSandBox/**/*.*;$(RepoRoot)/nuget/**/*.*;$(RepoRoot)/artifacts/**/*.*" />
      <_RepoRootFiles2 Include="$(RepoRoot)/artifacts/$(Rid)/**/*.*" />
  </ItemGroup>

  <Target Name="UltraAll" DependsOnTargets="Prepare;Compile;RunAllSandBoxAndPackage">

  </Target>

  <Target Name="RunAllSandBoxAndPackage" >
      <MSBuild Projects="$(MSBuildThisFileDirectory)/SandBoxAndPackage.proj" 
      Targets="SandBoxAndPackage"
            Properties="RepoRoot=$(RepoRoot);
            LinuxDistrosNeedNativeInstaller=%(LinuxDistrosNeedNativeInstaller.Identity);
            DockerFolder=%(LinuxDistrosNeedNativeInstaller.DockerFolder);
            BuildConfiguration=$(BuildConfiguration);
            " />
  </Target >

  <Target Name="PrepareSandBox" >
    <PropertyGroup>
      <RelativeSandBoxPackageOutputFolder>RelativeSandBoxPackageOutputFolder</RelativeSandBoxPackageOutputFolder>
    </PropertyGroup>

    <PropertyGroup>
      <_LinuxDistrosNeedNativeInstallerIdentity>$(RepoRoot)/artifactsSandBox/%(LinuxDistrosNeedNativeInstaller.Identity)</_LinuxDistrosNeedNativeInstallerIdentity>
    </PropertyGroup>
    <Copy
      SourceFiles="@(_RepoRootFiles)"
      DestinationFiles="@(_RepoRootFiles -> '$(_LinuxDistrosNeedNativeInstallerIdentity)/%(RecursiveDir)%(Filename)%(Extension)')"/>

    <Exec Command="sh -c 'cd $(_LinuxDistrosNeedNativeInstallerIdentity) &amp;&amp; git clean -fxd'"/>

    <Copy
      SourceFiles="@(_RepoRootFiles2)"
      DestinationFiles="@(_RepoRootFiles2 -> '$(_LinuxDistrosNeedNativeInstallerIdentity)/artifacts/$(Rid)/%(RecursiveDir)%(Filename)%(Extension)')"/>
  </Target>

  <Target Name="PackageWithDocker" DependsOnTargets="PrepareSandBox">
    <Exec Command="$(RepoRoot)/artifactsSandBox/%(LinuxDistrosNeedNativeInstaller.Identity)/build.sh --configuration $(BuildConfiguration) --docker %(LinuxDistrosNeedNativeInstaller.DockerFolder) --skip-prereqs /target:GenerateInstallersAndCopyOutOfSandBox /p:RelativeSandBoxPackageOutputFolder=$(RelativeSandBoxPackageOutputFolder)"/>
  </Target >

  <Target Name="CopyPackageResult">
    <ItemGroup>
      <_SandboxPackageResultFiles Include="$(RepoRoot)/artifactsSandBox/%(_LinuxDistrosNeedNativeInstallerIdentity)/$(RelativeSandBoxPackageOutputFolder)/**/*.*"/>
    </ItemGroup>
    <Copy
      SourceFiles="@(_SandboxPackageResultFiles)"
      DestinationFolder="$(InstallerOutputDirectory)/%(RecursiveDir)"/>
  </Target >
</Project>
  